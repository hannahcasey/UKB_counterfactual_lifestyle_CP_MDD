---
title: "Impact of lifestyle in chronic pain and depression: a Propensity Score Analysis in UK Biobank Supplementary Material"
output: 
  word_document:
    reference_docx: ~/Desktop/PhD/projects/UKB_CP_MDD_brain_structure/writeup/RMD_template.docx
---

```{r setup, include=FALSE}
library(kableExtra)
library(dplyr)
library(flextable)
library(stringr)
library(tidyr)
library(knitr)
library(openxlsx)
```

# Table of contents:\

## 1. Supplementary Methods
### 1.1. Treatment, outcome and matching variables in UK Biobank

## 2. Supplementary Results
### 2.1. Balancing output
### 2.2. Data missingness
### 2.3. Results from main analysis

\newpage
# 1. Supplementary Methods

\n
## 1.1. Treatment, outcome and matching variables in UK Biobank

```{r Variable table, echo=F, results='asis'}
table_counter <- 1

variable_table <- read.xlsx(xlsxFile = "~/Desktop/PhD/projects/UKB_CP_MDD_lifestyle_counterfactual/writeup/variable_table.xlsx", fillMergedCells = TRUE, colNames = TRUE)

flextable(variable_table) %>%
  merge_v(j = ~ Description + Field.ID + Original.coding) %>% ## Merge cells
  autofit() %>%
  fit_to_width(7) %>%
  merge_h() %>%
  bg(i = c(1, 18, 33), bg = "lightgrey", part = "body") %>%
  theme_booktabs()

cat(paste0("Table S", table_counter, ". Table of matching, outcome and exposure variables used in UK Biobank"))
```


\newpage
# 2. Supplementary Results

\n
## 2.1. Balancing output

```{r Balancing tables, echo=F, results='asis'}

observation_table_files <- list.files(path = "/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/balancing/", pattern = "_observation_table.csv")

bal_table_files <- list.files(path = "/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/balancing/", pattern = "bal_table")

## Sort table lists so order is: full, female, male
observation_table_files_sorted <- c(grep("_full_", observation_table_files, value = T), grep("_female_", observation_table_files, value = T), grep("_male_", observation_table_files, value = T))

bal_table_files_sorted <- c(grep("_full_", bal_table_files, value = T), grep("_female_", bal_table_files, value = T), grep("_male_", bal_table_files, value = T))


## Observation tables
for (file in observation_table_files_sorted){
  
  table_counter <- table_counter + 1
  
  table <- read.csv(paste0("/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/balancing/", file ))
  names(table) <- c("Sample", "Non-exposure", "Exposure")
  
  f <- flextable(table) %>%
  autofit() %>%
  fit_to_width(7) %>%
  theme_booktabs()
   
  ## Get sample
   if (grepl("female", file)){
    sample <- "female sample"
  } else if (grepl("male", file)) {
    sample <- "male sample"
  } else if (grepl("full", file)) {
    sample <- "full sample"
  }
  
  ## Get exposure
  if (grepl("PA_low_", file)){
   exposure <- "physical activity" 
  } else if (grepl("too_little_sleep", file)){
    exposure <- "insufficient sleep" 
  } else if (grepl("too_much_sleep", file)){
    exposure <- "excessive sleep" 
  } else if (grepl("high_alcohol_consumption", file)){
    exposure <- "high alcohol consumption" 
  } else if (grepl("smoking", file)){
    exposure <- "smoking" 
  } else if (grepl("obese", file)){
    exposure <- "obese" 
  } else if (grepl("lonely_", file)){
    exposure <- "loneliness" 
  } else if (grepl("unhealthy_diet", file)){
    exposure <- "unhealthy diet" 
  }
  
  flextable_to_rmd(f)
  cat(paste0("Table S", table_counter, ". Observation table of ", exposure, " in ", sample,". Sample sizes averaged over multiple imputations."))
  cat("\n\n\n\n")
  
}

## Balance tables
for (file in bal_table_files_sorted){
  
  table_counter <- table_counter + 1
  
  table <- read.csv(paste0("/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/balancing/", file ))
  names(table)[1] <- "Variables"
  
  ## Round numbers
  table <- table %>% mutate_if(is.numeric, round, digits=3)
  
  f <- flextable(table) %>%
  autofit() %>%
  fit_to_width(7) %>%
  theme_booktabs()
   
  ## Get sample
   if (grepl("female", file)){
    sample <- "female sample"
  } else if (grepl("male", file)) {
    sample <- "male sample"
  } else if (grepl("full", file)) {
    sample <- "full sample"
  }
  
  ## Get exposure
  if (grepl("PA_low_", file)){
   exposure <- "physical activity" 
  } else if (grepl("too_little_sleep", file)){
    exposure <- "insufficient sleep" 
  } else if (grepl("too_much_sleep", file)){
    exposure <- "excessive sleep" 
  } else if (grepl("high_alcohol_consumption", file)){
    exposure <- "high alcohol consumption" 
  } else if (grepl("smoking", file)){
    exposure <- "smoking" 
  } else if (grepl("obese", file)){
    exposure <- "obese" 
  } else if (grepl("lonely_", file)){
    exposure <- "loneliness" 
  } else if (grepl("unhealthy_diet", file)){
    exposure <- "unhealthy diet" 
  }
  
  flextable_to_rmd(f)
  cat(paste0("Table S", table_counter, ". Balance table of ", exposure, " in ", sample))
  cat("\n\n\n\n")
  
}

```


```{r Balancing plots, echo=F, results='asis'}

love_plot_paths <- list.files("/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/balancing",full.names = T, pattern = "love_plot")

love_plot_paths_sorted <- c(grep("_full_", love_plot_paths, value = T), grep("_female_", love_plot_paths, value = T), grep("_male_", love_plot_paths, value = T))
  
figure_counter <- 0

for (plot_path in love_plot_paths_sorted){

  figure_counter <- figure_counter + 1
  
  file <- basename(plot_path)

  ## Get sample
  
  if (grepl("male", file)){
    sample <- "male sample"
    } 
  if (grepl("female", file)) {
    sample <- "female sample"
    }
  if (grepl("full", file)) {
    sample <- "full sample"
    }

  ## Get exposure
  if (grepl("PA_low_", file)){
   exposure <- "physical activity" 
  } else if (grepl("too_little_sleep", file)){
    exposure <- "insufficient sleep" 
  } else if (grepl("too_much_sleep", file)){
    exposure <- "excessive sleep" 
  } else if (grepl("high_alcohol_consumption", file)){
    exposure <- "high alcohol consumption"
  } else if (grepl("smoking", file)){
    exposure <- "smoking"
  } else if (grepl("obese", file)){
    exposure <- "obese"
  } else if (grepl("lonely_", file)){
    exposure <- "loneliness"
  } else if (grepl("unhealthy_diet", file)){
    exposure <- "unhealthy diet"
  }
  
  cat("<center>")
  cat("\n")
  cat(paste0("![](", plot_path, "){height=50% width=50% }"))
  cat("\n")
  cat("<center>")
  cat(paste0("Table S", table_counter, ". Love plot of ", exposure, " in ", sample))
  cat("\n")
}
```

\newpage
## 2.2. Data Missingness

```{r data missingness, echo=F, results='asis'}
data_missingness <- read.csv("/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/data_missingness.csv")

names(data_missingness) <- c("Variable", "Missingness (%)")
f <- flextable(data_missingness) %>%
autofit() %>%
fit_to_width(7) %>%
theme_booktabs()

flextable_to_rmd(f)
table_counter <- table_counter + 1
cat(paste0("Table S", table_counter, ". Data missingness in full eligible sample"))

```


\newpage
## 2.3. Results from main analysis

```{r Results, echo=F, results='asis'}

results_table_files <- list.files(path = "/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/", pattern = "results.csv")

results_table_files_sorted <- c(grep("_full_", results_table_files, value = T), grep("_female_", results_table_files, value = T), grep("_male_", results_table_files, value = T))

## Observation tables
for (file in results_table_files_sorted){
  
  table_counter <- table_counter + 1
  
  table <- read.csv(paste0("/Volumes/GenScotDepression/users/hcasey/UKB_CP_MDD_lifestyle_CA/output/", file ))

  ## Remove sensitivity analysis
  table <- subset(table, table$exposure != "sensitivity_PA_low")
  
  ## Round numbers
  table <- table %>% mutate_if(is.numeric, round, digits=3)
  
  f <- flextable(table) %>%
  autofit() %>%
  fit_to_width(7) %>%
  theme_booktabs()
   
  ## Get sample
   if (grepl("female", file)){
    sample <- "female sample"
  } else if (grepl("male", file)) {
    sample <- "male sample"
  } else if (grepl("full", file)) {
    sample <- "full sample"
  }
  
    ## Get outcome
   if (grepl("CP_Dep_", file)){
    outcome <- "chronic pain and depression"
  } else if (grepl("CPDep_", file)) {
    outcome <- "comorbid chronic pain and depression groups"
  }
  
  flextable_to_rmd(f)
  cat(paste0("Table S", table_counter, ". Effect of lifesyle-related variables in ", outcome, " in ", sample))
  cat("\n\n\n\n")
  
}


```



